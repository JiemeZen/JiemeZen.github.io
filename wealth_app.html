<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WealthDex</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        /* Custom styles for better aesthetics and responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem; /* More rounded corners */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Softer shadow */
            padding: 1.5rem;
            margin-bottom: 1.5rem; /* Slightly reduced margin for coziness */
        }
        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="password"],
        input[type="date"],
        textarea { /* Added textarea styling */
            padding: 0.65rem; /* Slightly reduced padding */
            border: 1px solid #cbd5e0; /* Light border */
            border-radius: 0.5rem;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box; /* Include padding in width */
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus,
        input[type="date"]:focus,
        textarea:focus { /* Added textarea focus styling */
            outline: none;
            border-color: #6366f1; /* Indigo focus ring */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* Light indigo shadow on focus */
        }
        button {
            transition: all 0.2s ease-in-out;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-primary {
            background-color: #6366f1; /* Indigo */
            color: white;
            padding: 0.65rem 1.25rem; /* Shrunk padding */
            border-radius: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary:hover {
            background-color: #4f46e5; /* Darker indigo */
        }
        .btn-secondary {
            background-color: #e0e7ff; /* Light indigo */
            color: #4f46e5; /* Darker indigo */
            padding: 0.65rem 1.25rem; /* Shrunk padding */
            border-radius: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-secondary:hover {
            background-color: #c7d2fe; /* Even lighter indigo */
        }
        .btn-delete {
            color: #ef4444; /* Red */
            padding: 0.5rem;
            border-radius: 50%;
        }
        .btn-delete:hover {
            background-color: #fee2e2; /* Light red background on hover */
        }
        .btn-refresh {
            color: #3b82f6; /* Blue */
            padding: 0.5rem;
            border-radius: 50%;
        }
        .btn-refresh:hover {
            background-color: #dbeafe; /* Light blue background on hover */
        }
        .table-header th {
            padding: 0.75rem 1.5rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 500;
            color: #6b7280; /* Gray text */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background-color: #f9fafb; /* Light gray background */
            cursor: pointer; /* Indicate sortable */
        }
        .table-header th:hover {
            background-color: #f3f4f6; /* Hover effect for sortable headers */
        }
        .table-row td {
            padding: 1rem 1.5rem;
            font-size: 0.875rem;
            color: #4b5563; /* Darker gray text */
            white-space: nowrap;
        }
        .table-row:nth-child(even) {
            background-color: #f9fafb; /* Alternate row color */
        }
        .table-row:hover {
            background-color: #f3f4f6; /* Hover effect */
        }
        .gain {
            color: #10b981; /* Green for gain */
        }
        .loss {
            color: #ef4444; /* Red for loss */
        }
        .message {
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
            font-weight: 500;
        }
        .message.success {
            background-color: #d1fae5; /* Light green */
            color: #065f46; /* Dark green */
        }
        .message.error {
            background-color: #fee2e2; /* Light red */
            color: #991b1b; /* Dark red */
        }
        .message.info {
            background-color: #dbeafe; /* Light blue */
            color: #1e40af; /* Dark blue */
        }
        /* Treemap Specific Styles */
        #portfolioTreemapChart {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            height: auto; /* Allow height to adjust based on aspect ratio */
        }
        .node rect {
            /* fill: steelblue; Removed this line to allow D3.js to control fill */
            stroke: #fff;
        }
        .node text {
            font-size: 10px;
            fill: white;
            pointer-events: none; /* Allow events to pass through to rect */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6); /* Dark shadow for readability */
        }

        /* Historical Chart Specific Styles */
        #historicalPerformanceChart {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            height: auto;
        }
        .axis text {
            font-size: 10px;
            fill: #6b7280; /* Gray text for axes */
        }
        .axis path,
        .axis line {
            stroke: #d1d5db; /* Light gray lines for axes */
        }
        .line {
            fill: none;
            stroke-width: 2px;
        }
        .line.value {
            stroke: #6366f1; /* Indigo for value line */
        }
        .line.cost {
            stroke: #3b82f6; /* Blue for cost line */
            stroke-dasharray: 4 4; /* Dashed line for cost */
        }
        .chart-tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
        }
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 1rem;
            font-size: 0.875rem;
            color: #4b5563;
        }
        .chart-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .chart-legend-color {
            width: 16px;
            height: 4px;
            border-radius: 2px;
        }

        /* Dark Mode Overrides */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a202c; /* Dark background */
                color: #e2e8f0; /* Light text */
            }
            .container {
                /* No change needed, max-width and padding are layout properties */
            }
            .card {
                background-color: #2d3748; /* Darker card background */
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            }
            input[type="text"],
            input[type="number"],
            input[type="email"],
            input[type="password"],
            input[type="date"],
            textarea {
                background-color: #4a5568; /* Dark input background */
                border-color: #6b7280; /* Darker border */
                color: #e2e8f0; /* Light text */
            }
            input[type="text"]:focus,
            input[type="number"]:focus,
            input[type="email"]:focus,
            input[type="password"]:focus,
            input[type="date"]:focus,
            textarea:focus {
                border-color: #818cf8; /* Lighter indigo focus ring */
                box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.3);
            }
            .btn-primary {
                background-color: #4f46e5; /* Darker indigo */
            }
            .btn-primary:hover {
                background-color: #3730a3; /* Even darker indigo */
            }
            .btn-secondary {
                background-color: #4338ca; /* Darker indigo for secondary */
                color: #e0e7ff; /* Lighter text */
            }
            .btn-secondary:hover {
                background-color: #312e81; /* Even darker indigo */
            }
            .btn-delete {
                color: #fca5a5; /* Lighter red */
            }
            .btn-delete:hover {
                background-color: #450a0a; /* Darker red background on hover */
            }
            .btn-refresh {
                color: #93c5fd; /* Lighter blue */
            }
            .btn-refresh:hover {
                background-color: #1e3a8a; /* Darker blue background on hover */
            }
            .table-header th {
                background-color: #4a5568; /* Darker gray background */
                color: #a0aec0; /* Lighter gray text */
            }
            .table-header th:hover {
                background-color: #2d3748; /* Darker hover effect */
            }
            .table-row td {
                color: #cbd5e0; /* Lighter gray text */
            }
            .table-row:nth-child(even) {
                background-color: #2d3748; /* Darker alternate row color */
            }
            .table-row:hover {
                background-color: #4a5568; /* Darker hover effect */
            }
            .gain {
                color: #6ee7b7; /* Lighter green for gain */
            }
            .loss {
                color: #fca5a5; /* Lighter red for loss */
            }
            .message.success {
                background-color: #064e3b; /* Darker green */
                color: #a7f3d0; /* Lighter green */
            }
            .message.error {
                background-color: #7f1d1d; /* Darker red */
                color: #fecaca; /* Lighter red */
            }
            .message.info {
                background-color: #1e3a8a; /* Darker blue */
                color: #bfdbfe; /* Lighter blue */
            }
            .node text {
                fill: #e2e8f0; /* Light text for treemap labels */
            }
            .axis text {
                fill: #a0aec0; /* Lighter gray text for axes in dark mode */
            }
            .axis path,
            .axis line {
                stroke: #4a5568; /* Darker lines for axes in dark mode */
            }
            .line.value {
                stroke: #818cf8; /* Lighter indigo for value line in dark mode */
            }
            .line.cost {
                stroke: #93c5fd; /* Lighter blue for cost line in dark mode */
            }
            .chart-legend {
                color: #cbd5e0;
            }
            footer {
                color: #a0aec0; /* Lighter gray for footer text */
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-950 text-gray-900 dark:text-gray-100 min-h-screen p-4 sm:p-8">
    <div class="container">
        <header class="mb-8 text-center">
            <h1 class="text-4xl sm:text-5xl font-bold text-indigo-700 dark:text-indigo-400 mb-2">
                WealthDex
            </h1>
            <p class="text-lg text-gray-600 dark:text-gray-400">
                Simple Stock Portfolio Tracker
            </p>
        </header>

        <nav id="loggedInNav" class="hidden mb-6 flex flex-col sm:flex-row justify-between items-center bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg">
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-4 sm:mb-0">
                Logged in as: <span id="userEmailDisplay" class="font-mono bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded-md break-all"></span>
                <br/>ID: <span id="userIdDisplay" class="font-mono bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded-md break-all"></span>
            </div>
            <div class="flex space-x-2">
                <button id="navEntryBtn" class="btn-secondary">Entry</button>
                <button id="navDashboardBtn" class="btn-secondary">Dashboard</button>
                <button id="logoutBtn" class="btn-secondary">Logout</button>
            </div>
        </nav>

        <div id="messageDisplay" class="message hidden"></div>

        <div id="loginPage" class="page">
            <section class="card w-full sm:w-2/3 lg:w-1/2 mx-auto">
                <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300 mb-4 text-center">Login / Sign Up</h2>
                <div class="space-y-4 mb-6">
                    <input type="email" id="loginEmail" placeholder="Email" required>
                    <input type="password" id="loginPassword" placeholder="Password" required>
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="loginBtn" class="btn-primary flex-1">Login</button>
                    <button id="signupBtn" class="btn-secondary flex-1">Sign Up</button>
                </div>
                <p class="text-sm text-gray-500 dark:text-gray-400 text-center mt-4">
                    Use email/password to login or sign up.
                </p>
            </section>
        </div>

        <div id="entryPage" class="page hidden">
            <section class="card mb-8">
                <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300 mb-4">Add New Stock</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                    <input type="text" id="newTicker" placeholder="Ticker (e.g., AAPL)">
                    <input type="number" id="newShares" placeholder="Shares">
                    <input type="number" step="0.01" id="newDcaPrice" placeholder="DCA Price">
                </div>
                <button id="addStockBtn" class="btn-primary w-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-plus"><path d="M12 5v14M5 12h14"/></svg>
                    <span>Add Stock to Portfolio</span>
                </button>
            </section>

            <section class="card">
                <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300 mb-4">Record Dividend</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                    <input type="text" id="dividendTicker" placeholder="Ticker (e.g., G3B)">
                    <input type="number" step="0.01" id="dividendAmount" placeholder="Amount (e.g., 50.00)">
                    <input type="date" id="dividendDate">
                </div>
                <button id="recordDividendBtn" class="btn-primary w-full bg-green-600 hover:bg-green-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-dollar-sign"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    <span>Record Dividend</span>
                </button>
            </section>
        </div>

        <div id="dashboardPage" class="page hidden">
            <section class="card">
                <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300 mb-4">Portfolio Summary</h2>
                <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 text-center"> <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Total Cost</p>
                        <p id="totalCost" class="text-xl font-bold text-gray-800 dark:text-gray-200">$0.00</p>
                    </div>
                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Current Value</p>
                        <p id="totalValue" class="text-xl font-bold text-gray-800 dark:text-gray-200">$0.00</p>
                    </div>
                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Total Dividends</p>
                        <p id="totalDividends" class="text-xl font-bold text-gray-800 dark:text-gray-200">$0.00</p>
                    </div>
                    <div id="gainLossSummary" class="p-4 rounded-lg shadow-sm">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Total Gain/Loss (incl. Dividends)</p>
                        <p id="totalGainLoss" class="text-xl font-bold">$0.00 (0.00%)</p>
                    </div>
                </div>
                <button id="saveSnapshotBtn" class="btn-primary w-full mt-6 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-save"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    <span>Save Daily Snapshot</span>
                </button>
            </section>

            <!-- Portfolio Allocation (Treemap) -->
            <section class="card">
                <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300 mb-4">Portfolio Allocation (Treemap)</h2>
                <div class="flex justify-center items-center">
                    <svg id="portfolioTreemapChart"></svg> </div>
                </section>

            <section class="card">
                <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300 mb-4">Your Positions</h2>
                <div id="portfolioEmptyMessage" class="text-center text-gray-500 dark:text-gray-400 hidden">
                    No stocks in your portfolio yet. Add some on the Entry page!
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider rounded-tl-lg">Ticker</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Shares</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">DCA Price</th>
                                <th scope="col" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Mkt Price</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Cost</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Value</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Gain ($)</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Gain (%)</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider rounded-tr-lg">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="portfolioTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                    </table>
                </div>
            </section>

            <!-- Dividend History Section -->
            <section class="card">
                <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300 mb-4">Dividend History</h2>
                <div id="dividendEmptyMessage" class="text-center text-gray-500 dark:text-gray-400 hidden">
                    No dividends recorded yet.
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider rounded-tl-lg" data-sort-key="date" data-sort-order="desc">
                                    Date
                                    <span class="sort-icon inline-block ml-1" data-sort-key="date"></span>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" data-sort-key="ticker" data-sort-order="asc">
                                    Ticker
                                    <span class="sort-icon inline-block ml-1" data-sort-key="ticker"></span>
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Amount</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider rounded-tr-lg">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dividendHistoryTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                    </table>
                </div>
            </section>

            <!-- Historical Performance Chart Section -->
            <section class="card">
                <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300 mb-4">Historical Performance</h2>
                <div class="flex justify-center items-center">
                    <svg id="historicalPerformanceChart"></svg>
                </div>
                <div class="chart-legend">
                    <div class="chart-legend-item">
                        <span class="chart-legend-color line-value bg-indigo-500 dark:bg-indigo-400"></span>
                        <span>Portfolio Value</span>
                    </div>
                    <div class="chart-legend-item">
                        <span class="chart-legend-color line-cost bg-blue-500 dark:bg-blue-400"></span>
                        <span>Total Cost</span>
                    </div>
                </div>
            </section>

            <!-- Stock Insight Generator Section -->
            <section class="card">
                <h2 class="text-2xl font-semibold text-indigo-600 dark:text-indigo-300 mb-4">✨ AI Stock Insight</h2>
                <div class="space-y-4">
                    <div>
                        <label for="insightTicker" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Enter Ticker Symbol:</label>
                        <input type="text" id="insightTicker" placeholder="e.g., TSLA" class="w-full">
                    </div>
                    <button id="getInsightBtn" class="btn-primary w-full bg-purple-600 hover:bg-purple-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-lightbulb"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 6c0 1.8-.5 3.1-1.5 4.5-1 .8-1.5 1.5-1.5 2.5 0 2.5 2 5 4 5h8c2 0 4-2.5 4-5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>
                        <span>Get Insight</span>
                    </button>
                    <div id="insightResult" class="mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg text-gray-800 dark:text-gray-200 min-h-[80px] flex items-center justify-center text-center">
                        Enter a ticker and click "Get Insight" to learn more.
                    </div>
                </div>

                <!-- New Insight Display Sections -->
                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg shadow-sm">
                        <h3 class="font-semibold text-indigo-700 dark:text-indigo-300 mb-2">Primary Business</h3>
                        <p id="primaryBusinessDiv" class="text-sm text-gray-800 dark:text-gray-200">N/A</p>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg shadow-sm">
                        <h3 class="font-semibold text-indigo-700 dark:text-indigo-300 mb-2">Recent Highlight</h3>
                        <p id="recentHighlightDiv" class="text-sm text-gray-800 dark:text-gray-200">N/A</p>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg shadow-sm">
                        <h3 class="font-semibold text-indigo-700 dark:text-indigo-300 mb-2">General Outlook</h3>
                        <p id="generalOutlookDiv" class="text-sm text-gray-800 dark:text-gray-200">N/A</p>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg shadow-sm">
                        <h3 class="font-semibold text-indigo-700 dark:text-indigo-300 mb-2">Analyst Consensus</h3>
                        <p id="analystConsensusDiv" class="text-sm text-gray-800 dark:text-gray-200">N/A</p>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg shadow-sm">
                        <h3 class="font-semibold text-indigo-700 dark:text-indigo-300 mb-2">Economic Moat</h3>
                        <p id="economicMoatDiv" class="text-sm text-gray-800 dark:text-gray-200">N/A</p>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg shadow-sm col-span-1 md:col-span-2">
                        <h3 class="font-semibold text-indigo-700 dark:text-indigo-300 mb-2">Financial Statements Summary <span class="text-xs text-gray-500 dark:text-gray-400">(Not real-time data)</span></h3>
                        <p id="financialStatementsDiv" class="text-sm text-gray-800 dark:text-gray-200">N/A</p>
                    </div>
                </div>
            </section>

            <footer class="mt-8 text-center text-gray-600 dark:text-gray-400">
                <p>&copy; Jimmy Zeng 2025</p>
            </footer>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // Added getDocs

        // ====================================================================================================
        // IMPORTANT: FOR GITHUB PAGES DEPLOYMENT, YOU MUST REPLACE THESE PLACEHOLDERS
        // WITH YOUR ACTUAL FIREBASE CONFIGURATION AND APP ID.
        // Get this from your Firebase Console -> Project settings -> Your apps -> Web app -> Firebase SDK snippet.
        // ====================================================================================================

        // Global variables provided by Canvas (or fallback for local testing)
        // If __app_id and __firebase_config are provided by the Canvas environment, use them.
        // Otherwise, use the example placeholders.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'wealthapp-2cddf';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyD6ZcQw20CqGspKvCuNCwp3TevagKdKhQg",
            authDomain: "wealthapp-2cddf.firebaseapp.com",
            projectId: "wealthapp-2cddf",
            storageBucket: "wealthapp-2cddf.firebasestorage.app",
            messagingSenderId: "114330023809",
            appId: "1:114330023809:web:83bd0874d90ff75e6ada80",
            measurementId: "G-0J6QBYJXY6"
        };
        // __initial_auth_token is provided by Canvas for anonymous login.
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? initialAuthToken : null;

        // ====================================================================================================
        // END OF REQUIRED CHANGES FOR GITHUB PAGES (ensure your actual config is here)
        // ====================================================================================================


        let db;
        let auth;
        let currentUserId = null;
        let currentUserEmail = null;
        let isAuthReady = false;
        // portfolioData now holds an object with 'stocks' and 'dividends' arrays
        let portfolioData = { stocks: [], dividends: [] };
        let dailySnapshots = []; // New array to store historical snapshots

        // Current sort state for dividend history table
        let currentDividendSortKey = 'date';
        let currentDividendSortOrder = 'desc';

        // DOM elements
        const loggedInNav = document.getElementById('loggedInNav');
        const userEmailDisplay = document.getElementById('userEmailDisplay');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const messageDisplay = document.getElementById('messageDisplay');

        // Login Page elements
        const loginPage = document.getElementById('loginPage');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');

        // Entry Page elements
        const entryPage = document.getElementById('entryPage');
        const newTickerInput = document.getElementById('newTicker');
        const newSharesInput = document.getElementById('newShares');
        const newDcaPriceInput = document.getElementById('newDcaPrice');
        const addStockBtn = document.getElementById('addStockBtn');
        const navEntryBtn = document.getElementById('navEntryBtn');

        // New Dividend Entry elements
        const dividendTickerInput = document.getElementById('dividendTicker');
        const dividendAmountInput = document.getElementById('dividendAmount');
        const dividendDateInput = document.getElementById('dividendDate');
        const recordDividendBtn = document.getElementById('recordDividendBtn');


        // Dashboard Page elements
        const dashboardPage = document.getElementById('dashboardPage');
        const portfolioTableBody = document.getElementById('portfolioTableBody');
        const portfolioEmptyMessage = document.getElementById('portfolioEmptyMessage');
        const totalCostEl = document.getElementById('totalCost');
        const totalValueEl = document.getElementById('totalValue');
        const totalGainLossEl = document.getElementById('totalGainLoss');
        const gainLossSummaryEl = document.getElementById('gainLossSummary');
        const totalDividendsEl = document.getElementById('totalDividends'); // New
        const navDashboardBtn = document.getElementById('navDashboardBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const saveSnapshotBtn = document.getElementById('saveSnapshotBtn'); // New snapshot button

        // New Dividend History elements
        const dividendHistoryTableBody = document.getElementById('dividendHistoryTableBody');
        const dividendEmptyMessage = document.getElementById('dividendEmptyMessage');
        const dividendTableHeaderDate = document.querySelector('th[data-sort-key="date"]');
        const dividendTableHeaderTicker = document.querySelector('th[data-sort-key="ticker"]');


        // New Treemap Chart elements
        const portfolioTreemapChartSvg = document.getElementById('portfolioTreemapChart');

        // New Historical Performance Chart elements
        const historicalPerformanceChartSvg = document.getElementById('historicalPerformanceChart');

        // New LLM Insight elements
        const insightTickerInput = document.getElementById('insightTicker');
        const getInsightBtn = document.getElementById('getInsightBtn');
        const insightResultDiv = document.getElementById('insightResult');

        // New specific insight display elements
        const primaryBusinessDiv = document.getElementById('primaryBusinessDiv');
        const recentHighlightDiv = document.getElementById('recentHighlightDiv');
        const generalOutlookDiv = document.getElementById('generalOutlookDiv');
        const analystConsensusDiv = document.getElementById('analystConsensusDiv');
        const economicMoatDiv = document.getElementById('economicMoatDiv');
        const financialStatementsDiv = document.getElementById('financialStatementsDiv');


        // Flag to prevent multiple rapid price fetches on initial load/navigation
        let hasFetchedPricesOnDashboardLoad = false;


        /**
         * Displays a message to the user.
         * @param {string} messageText - The message to display.
         * @param {'success'|'error'|'info'} type - The type of message (for styling).
         */
        function showMessage(messageText, type = 'info') {
            // Clear any existing timeout to prevent messages from disappearing too quickly
            clearTimeout(messageDisplay.dataset.timeoutId);

            messageDisplay.textContent = messageText;
            messageDisplay.className = `message ${type}`; // Reset classes and apply new type
            messageDisplay.classList.remove('hidden');

            // Set a new timeout and store its ID
            const timeoutId = setTimeout(() => {
                messageDisplay.classList.add('hidden');
            }, 5000); // Hide after 5 seconds
            messageDisplay.dataset.timeoutId = timeoutId;
        }

        /**
         * Shows a specific page and hides others.
         * @param {HTMLElement} pageToShow - The DOM element of the page to show.
         */
        function showPage(pageToShow) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            pageToShow.classList.remove('hidden');

            // If navigating to the dashboard, trigger a price refresh if not already done
            if (pageToShow === dashboardPage && isAuthReady && !hasFetchedPricesOnDashboardLoad) {
                refreshAllStocksMarketPrices();
                hasFetchedPricesOnDashboardLoad = true; // Set flag to prevent immediate re-fetch
            }
        }

        /**
         * Initializes Firebase and sets up authentication.
         */
        async function initializeFirebase() {
            try {
                // Check if firebaseConfig is properly set up
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY" ||
                    !firebaseConfig.projectId || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
                    console.error("Firebase configuration is missing or invalid. Please update firebaseConfig with your actual project details.");
                    showMessage("Error: Firebase configuration is not set up correctly. Please check the code.", 'error');
                    db = null;
                    auth = null;
                    showPage(loginPage); // Always show login page if config is bad
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Handle Canvas preview automatic login using __initial_auth_token
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    // onAuthStateChanged will be triggered after signInWithCustomToken
                } else {
                    // Standard email/password or anonymous sign-in flow for non-Canvas environments
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            currentUserId = user.uid;
                            currentUserEmail = user.email || 'Anonymous';
                            userIdDisplay.textContent = currentUserId;
                            userEmailDisplay.textContent = currentUserEmail;
                            loggedInNav.classList.remove('hidden');
                            isAuthReady = true;
                            setupRealtimeListener(); // Start listening for data once auth is ready
                            showPage(dashboardPage); // Initial page display after auth
                        } else {
                            console.warn("No user logged in. Showing login page.");
                            loggedInNav.classList.add('hidden');
                            showPage(loginPage);
                            isAuthReady = false; // Reset auth ready state
                            hasFetchedPricesOnDashboardLoad = false; // Reset flag for next login
                        }
                    });
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessage(`Initialization error: ${error.message}. Please check your Firebase configuration and internet connection.`, 'error');
                db = null;
                auth = null;
                showPage(loginPage); // Always show login page if any initialization error occurs
            }
        }

        /**
         * Handles user signup with email and password.
         */
        async function handleSignUp() {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;

            if (!auth) {
                showMessage("Firebase Auth is not initialized. Please check Firebase configuration.", 'error');
                return;
            }
            if (!email || !password) {
                showMessage("Please enter both email and password.", 'error');
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showMessage("Account created successfully! You are now logged in.", 'success');
                // onAuthStateChanged will handle page redirection
            } catch (error) {
                console.error("Signup error:", error);
                showMessage(`Signup failed: ${error.message}`, 'error');
            }
        }

        /**
         * Handles user login with email and password.
         */
        async function handleLogin() {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;

            if (!auth) {
                showMessage("Firebase Auth is not initialized. Please check Firebase configuration.", 'error');
                return;
            }
            if (!email || !password) {
                showMessage("Please enter both email and password.", 'error');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage("Logged in successfully!", 'success');
                // onAuthStateChanged will handle page redirection
            } catch (error) {
                console.error("Login error:", error);
                showMessage(`Login failed: ${error.message}`, 'error');
            }
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            if (!auth) {
                showMessage("Firebase Auth is not initialized. Cannot log out.", 'error');
                return;
            }
            try {
                await signOut(auth);
                showMessage("Logged out successfully.", 'info');
                portfolioData = { stocks: [], dividends: [] }; // Clear all portfolio data on logout
                dailySnapshots = []; // Clear historical data
                renderPortfolio(portfolioData.stocks); // Clear stock UI
                renderDividendHistory(portfolioData.dividends); // Clear dividend UI
                updatePortfolioSummary(portfolioData.stocks, portfolioData.dividends); // Clear summary
                renderHistoricalChart([]); // Clear historical chart
                loggedInNav.classList.add('hidden');
                showPage(loginPage);
                hasFetchedPricesOnDashboardLoad = false; // Reset flag for next login
            } catch (error) {
                console.error("Logout error:", error);
                showMessage(`Logout failed: ${error.message}`, 'error');
            }
        }

        /**
         * Sets up real-time listeners for the user's portfolio data and daily snapshots.
         */
        function setupRealtimeListener() {
            if (!db || !currentUserId || !isAuthReady) {
                return;
            }

            // Listener for portfolio data (stocks and dividends)
            const portfolioDocPath = `artifacts/${appId}/users/${currentUserId}/user_data/portfolio_json`;
            const portfolioDocRef = doc(db, portfolioDocPath);

            onSnapshot(portfolioDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    try {
                        const parsedContent = JSON.parse(data.portfolioContent || '{}');
                        portfolioData.stocks = parsedContent.stocks || [];
                        portfolioData.dividends = parsedContent.dividends || [];
                    } catch (e) {
                        console.error("Error parsing portfolio JSON:", e);
                        portfolioData = { stocks: [], dividends: [] };
                        showMessage("Error loading portfolio data. Data might be corrupted.", 'error');
                    }
                } else {
                    portfolioData = { stocks: [], dividends: [] };
                }
                renderPortfolio(portfolioData.stocks);
                renderDividendHistory(portfolioData.dividends, currentDividendSortKey, currentDividendSortOrder);
                updatePortfolioSummary(portfolioData.stocks, portfolioData.dividends);
                renderTreemap(portfolioData.stocks);
                // Enable/disable snapshot button based on current portfolio state
                checkAndEnableSnapshotButton();
            }, (error) => {
                console.error("Error fetching portfolio document:", error);
                showMessage(`Error loading portfolio: ${error.message}`, 'error');
            });

            // Listener for daily snapshots
            const snapshotsCollectionPath = `artifacts/${appId}/users/${currentUserId}/daily_snapshots`;
            const snapshotsCollectionRef = collection(db, snapshotsCollectionPath);
            const q = query(snapshotsCollectionRef); // No specific ordering needed for onSnapshot, we'll sort client-side

            onSnapshot(q, (querySnapshot) => {
                dailySnapshots = [];
                querySnapshot.forEach((doc) => {
                    dailySnapshots.push(doc.data());
                });
                // Sort snapshots by date before rendering the chart
                dailySnapshots.sort((a, b) => new Date(a.date) - new Date(b.date));
                renderHistoricalChart(dailySnapshots);
            }, (error) => {
                console.error("Error fetching daily snapshots:", error);
                showMessage(`Error loading historical data: ${error.message}`, 'error');
            });
        }

        /**
         * Saves the current portfolioData object as a JSON string to Firestore.
         * @param {Object} dataToSave - The object containing stocks and dividends arrays.
         */
        async function savePortfolio(dataToSave) {
            if (!db || !currentUserId) {
                showMessage("Error: Not authenticated or database not ready to save.", 'error');
                return;
            }
            const docPath = `artifacts/${appId}/users/${currentUserId}/user_data/portfolio_json`;
            const docRef = doc(db, docPath);
            try {
                // Save the entire portfolioData object as a JSON string
                await setDoc(docRef, { portfolioContent: JSON.stringify(dataToSave) });
                // No message here, as onSnapshot will trigger render and message if needed
            } catch (e) {
                console.error("Error saving portfolio JSON:", e);
                showMessage(`Error saving portfolio: ${e.message}`, 'error');
            }
        }

        /**
         * Renders the portfolio data into the HTML table.
         * @param {Array<Object>} stocks - The array of stock objects.
         */
        function renderPortfolio(stocks) {
            portfolioTableBody.innerHTML = ''; // Clear existing rows

            if (stocks.length === 0) {
                portfolioEmptyMessage.classList.remove('hidden');
            } else {
                portfolioEmptyMessage.classList.add('hidden');
            }

            stocks.forEach(stock => {
                const cost = stock.shares * stock.dcaPrice;
                const value = stock.shares * (stock.marketPrice || stock.dcaPrice);
                const gainLoss = value - cost;
                const gainLossPercent = cost > 0 ? (gainLoss / cost) * 100 : 0;

                const row = document.createElement('tr');
                row.className = "table-row hover:bg-gray-50 dark:hover:bg-gray-700 transition duration-150 ease-in-out";
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${stock.ticker}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${stock.shares}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">$${stock.dcaPrice.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                        ${stock.marketPrice ? `$${stock.marketPrice.toFixed(2)}` : 'N/A'}
                        <button class="ml-2 p-1 rounded-full bg-blue-100 hover:bg-blue-200 dark:bg-blue-900 dark:hover:bg-blue-800 text-blue-600 dark:text-blue-300 transition duration-150 ease-in-out btn-refresh" data-id="${stock.id}" data-ticker="${stock.ticker}" title="Refresh Market Price">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-refresh-cw"><path d="M21 12a9 9 0 0 0-9-9c-7.2 0-9 1.8-9 9s1.8 9 9 9a9 9 0 0 0 9-9"/><path d="M17 12h-5v5"/></svg>
                        </button>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">$${cost.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">$${value.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${gainLoss >= 0 ? 'gain' : 'loss'}">$${gainLoss.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${gainLossPercent >= 0 ? 'gain' : 'loss'}">${gainLossPercent.toFixed(2)}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-200 transition duration-150 ease-in-out p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900 btn-delete" data-id="${stock.id}" data-ticker="${stock.ticker}" title="Delete Stock">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </td>
                `;
                portfolioTableBody.appendChild(row);
            });

            // Attach event listeners to newly created buttons
            document.querySelectorAll('.btn-delete').forEach(button => {
                button.onclick = (event) => {
                    const id = event.currentTarget.dataset.id;
                    const ticker = event.currentTarget.dataset.ticker;
                    deleteStock(id, ticker);
                };
            });
            document.querySelectorAll('.btn-refresh').forEach(button => {
                button.onclick = (event) => {
                    const id = event.currentTarget.dataset.id;
                    const ticker = event.currentTarget.dataset.ticker;
                    fetchMarketPrice(id, ticker); // Call the actual fetch function
                };
            });
        }

        /**
         * Renders the dividend history data into the HTML table.
         * @param {Array<Object>} dividends - The array of dividend objects.
         * @param {string} sortKey - The key to sort by ('date' or 'ticker').
         * @param {string} sortOrder - The sort order ('asc' or 'desc').
         */
        function renderDividendHistory(dividends, sortKey, sortOrder) {
            dividendHistoryTableBody.innerHTML = ''; // Clear existing rows

            if (dividends.length === 0) {
                dividendEmptyMessage.classList.remove('hidden');
            } else {
                dividendEmptyMessage.classList.add('hidden');
            }

            // Sort dividends based on provided key and order
            const sortedDividends = [...dividends].sort((a, b) => {
                let valA = a[sortKey];
                let valB = b[sortKey];

                if (sortKey === 'date') {
                    valA = new Date(valA);
                    valB = new Date(valB);
                } else if (sortKey === 'ticker') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
                if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
                return 0;
            });

            // Update sort icons in headers
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.innerHTML = ''; // Clear existing icons
            });
            const currentSortIcon = document.querySelector(`.sort-icon[data-sort-key="${sortKey}"]`);
            if (currentSortIcon) {
                currentSortIcon.innerHTML = sortOrder === 'asc' ? '&#9650;' : '&#9660;'; // Up arrow for asc, down for desc
            }


            sortedDividends.forEach(dividend => {
                const row = document.createElement('tr');
                row.className = "table-row hover:bg-gray-50 dark:hover:bg-gray-700 transition duration-150 ease-in-out";
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${dividend.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${dividend.ticker}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">$${dividend.amount.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-200 transition duration-150 ease-in-out p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900 btn-delete-dividend" data-id="${dividend.id}" data-ticker="${dividend.ticker}" title="Delete Dividend">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </td>
                `;
                dividendHistoryTableBody.appendChild(row);
            });

            document.querySelectorAll('.btn-delete-dividend').forEach(button => {
                button.onclick = (event) => {
                    const id = event.currentTarget.dataset.id;
                    const ticker = event.currentTarget.dataset.ticker;
                    deleteDividend(id, ticker);
                };
            });
        }


        /**
         * Updates the portfolio summary section.
         * @param {Array<Object>} stocks - The array of stock objects.
         * @param {Array<Object>} dividends - The array of dividend objects.
         */
        function updatePortfolioSummary(stocks, dividends) {
            const totalCost = stocks.reduce((sum, stock) => sum + (stock.shares * stock.dcaPrice), 0);
            const totalValue = stocks.reduce((sum, stock) => sum + (stock.shares * (stock.marketPrice || stock.dcaPrice)), 0);
            const totalDividends = dividends.reduce((sum, dividend) => sum + dividend.amount, 0);
            const totalGainLoss = (totalValue - totalCost) + totalDividends; // P&L combined with dividends
            const gainLossPercentage = totalCost > 0 ? (totalGainLoss / totalCost) * 100 : 0;


            totalCostEl.textContent = `$${totalCost.toFixed(2)}`;
            totalValueEl.textContent = `$${totalValue.toFixed(2)}`;
            totalGainLossEl.textContent = `$${totalGainLoss.toFixed(2)} (${gainLossPercentage.toFixed(2)}%)`;
            totalDividendsEl.textContent = `$${totalDividends.toFixed(2)}`; // Update total dividends

            // Update summary card styling based on gain/loss
            if (totalGainLoss >= 0) {
                gainLossSummaryEl.className = 'p-4 rounded-lg shadow-sm bg-green-50 dark:bg-green-900';
                totalGainLossEl.classList.remove('loss');
                totalGainLossEl.classList.add('gain');
            } else {
                gainLossSummaryEl.className = 'p-4 rounded-lg shadow-sm bg-red-50 dark:bg-red-900';
                totalGainLossEl.classList.remove('gain');
                totalGainLossEl.classList.add('loss');
            }
        }

        /**
         * Checks if all stocks have a valid market price and enables/disables the snapshot button.
         */
        function checkAndEnableSnapshotButton() {
            const allPricesValid = portfolioData.stocks.length > 0 &&
                                   portfolioData.stocks.every(stock => stock.marketPrice && stock.marketPrice > 0);
            saveSnapshotBtn.disabled = !allPricesValid;
            if (!allPricesValid && portfolioData.stocks.length > 0) {
                saveSnapshotBtn.title = "Refresh all market prices to enable snapshot.";
            } else if (portfolioData.stocks.length === 0) {
                saveSnapshotBtn.title = "Add stocks to your portfolio to enable snapshot.";
            } else {
                saveSnapshotBtn.title = "Save current portfolio as a daily snapshot.";
            }
        }


        /**
         * Adds a new stock to the portfolioData.stocks array and saves it to Firestore.
         */
        async function addStock() {
            if (!db || !currentUserId) {
                showMessage("Error: Not authenticated or database not ready.", 'error');
                return;
            }

            const ticker = newTickerInput.value.trim();
            const shares = parseFloat(newSharesInput.value);
            const dcaPrice = parseFloat(newDcaPriceInput.value);

            if (!ticker || isNaN(shares) || isNaN(dcaPrice) || shares <= 0 || dcaPrice <= 0) {
                showMessage("Please fill in all fields (Ticker, Shares, DCA Price) with valid positive numbers.", 'error');
                return;
            }

            // Generate a unique ID for the new stock
            const newStockId = Date.now().toString() + Math.random().toString(36).substring(2, 9);

            const newStock = {
                id: newStockId,
                ticker: ticker.toUpperCase(),
                shares: shares,
                dcaPrice: dcaPrice,
                marketPrice: 0, // Placeholder
                timestamp: Date.now()
            };

            portfolioData.stocks.push(newStock);
            await savePortfolio(portfolioData); // Save the updated object

            newTickerInput.value = '';
            newSharesInput.value = '';
            newDcaPriceInput.value = '';
            showMessage(`Added ${ticker.toUpperCase()} to your portfolio!`, 'success');
        }

        /**
         * Deletes a stock from the portfolioData.stocks array and saves it to Firestore.
         * @param {string} id - The unique ID of the stock to delete.
         * @param {string} ticker - The ticker symbol of the stock (for messages).
         */
        async function deleteStock(id, ticker) {
            if (!db || !currentUserId) {
                showMessage("Error: Not authenticated or database not ready.", 'error');
                return;
            }
            const initialLength = portfolioData.stocks.length;
            portfolioData.stocks = portfolioData.stocks.filter(stock => stock.id !== id);
            if (portfolioData.stocks.length < initialLength) {
                await savePortfolio(portfolioData);
                showMessage(`Deleted ${ticker} from your portfolio.`, 'success');
            } else {
                showMessage(`Could not find ${ticker} to delete.`, 'error');
            }
        }

        /**
         * Records a new dividend to the portfolioData.dividends array and saves it to Firestore.
         */
        async function recordDividend() {
            if (!db || !currentUserId) {
                showMessage("Error: Not authenticated or database not ready.", 'error');
                return;
            }

            const ticker = dividendTickerInput.value.trim();
            const amount = parseFloat(dividendAmountInput.value);
            const date = dividendDateInput.value; // YYYY-MM-DD format

            if (!ticker || isNaN(amount) || amount <= 0 || !date) {
                showMessage("Please fill in all fields (Ticker, Amount, Date) with valid positive amount.", 'error');
                return;
            }

            const newDividendId = Date.now().toString() + Math.random().toString(36).substring(2, 9);

            const newDividend = {
                id: newDividendId,
                ticker: ticker.toUpperCase(),
                amount: amount,
                date: date,
                timestamp: Date.now() // For internal sorting if needed
            };

            portfolioData.dividends.push(newDividend);
            await savePortfolio(portfolioData);

            dividendTickerInput.value = '';
            dividendAmountInput.value = '';
            dividendDateInput.value = '';
            showMessage(`Recorded $${amount.toFixed(2)} dividend for ${ticker.toUpperCase()} on ${date}!`, 'success');
        }

        /**
         * Deletes a dividend from the portfolioData.dividends array and saves it to Firestore.
         * @param {string} id - The unique ID of the dividend to delete.
         * @param {string} ticker - The ticker symbol of the dividend (for messages).
         */
        async function deleteDividend(id, ticker) {
            if (!db || !currentUserId) {
                showMessage("Error: Not authenticated or database not ready.", 'error');
                return;
            }
            const initialLength = portfolioData.dividends.length;
            portfolioData.dividends = portfolioData.dividends.filter(dividend => dividend.id !== id);
            if (portfolioData.dividends.length < initialLength) {
                await savePortfolio(portfolioData);
                showMessage(`Deleted dividend for ${ticker}.`, 'success');
            } else {
                showMessage(`Could not find dividend for ${ticker} to delete.`, 'error');
            }
        }


        /**
         * Fetches market price for a single stock by scraping Yahoo Finance using a CORS proxy.
         * IMPORTANT: Relying on public CORS proxies for production is not recommended due to
         * reliability, security, and rate limit concerns.
         * @param {string} stockId - The unique ID of the stock to update.
         * @param {string} ticker - The ticker symbol to search for.
         */
        async function fetchMarketPrice(stockId, ticker) {
            showMessage(`Attempting to fetch market price for ${ticker} via proxy... (Note: Public proxies can be unreliable)`, 'info');
            // Yahoo Finance URL for SGX stocks often uses .SI suffix for Singapore.
            // For other markets, the suffix might differ or be absent.
            const yahooFinanceUrl = `https://sg.finance.yahoo.com/quote/${ticker}/`;
            // Using a public CORS proxy. Use with caution.
            const proxyUrl = 'https://api.allorigins.win/raw?url=';
            const targetUrl = proxyUrl + encodeURIComponent(yahooFinanceUrl);

            try {
                const response = await fetch(targetUrl);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const htmlText = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlText, 'text/html');

                // Find the element with data-testid="qsp-price"
                const priceElement = doc.querySelector('[data-testid="qsp-price"]');
                let price = 'N/A';

                if (priceElement) {
                    price = parseFloat(priceElement.textContent.replace(/,/g, '')); // Remove commas for parsing
                }

                if (price !== 'N/A' && !isNaN(price)) {
                    // Find the stock in the local array and update its marketPrice
                    const stockIndex = portfolioData.stocks.findIndex(stock => stock.id === stockId);
                    if (stockIndex !== -1) {
                        portfolioData.stocks[stockIndex].marketPrice = price;
                        portfolioData.stocks[stockIndex].lastUpdated = Date.now();
                        await savePortfolio(portfolioData); // Save the updated object
                        showMessage(`Updated market price for ${ticker}: $${price.toFixed(2)}`, 'success');
                    } else {
                        showMessage(`Stock with ID ${stockId} not found in local portfolio.`, 'error');
                    }
                } else {
                    showMessage(`Could not find live price for ${ticker}. Check ticker or try again.`, 'error');
                }

            } catch (error) {
                console.error("Error fetching market price via proxy:", error);
                showMessage(`Failed to fetch price for ${ticker}. Try refreshing.`, 'error');
            } finally {
                checkAndEnableSnapshotButton(); // Re-check button state after price fetch attempt
            }
        }

        /**
         * Refreshes market prices for all stocks in the portfolio.
         */
        function refreshAllStocksMarketPrices() {
            if (portfolioData.stocks.length > 0) {
                showMessage("Refreshing all stock market prices...", 'info');
                portfolioData.stocks.forEach(stock => fetchMarketPrice(stock.id, stock.ticker));
            } else {
                showMessage("No stocks in portfolio to refresh prices.", 'info');
            }
        }

        /**
         * Renders a D3.js treemap of stock positions by current market value, colored by performance.
         * @param {Array<Object>} stocks - The array of stock objects.
         */
        function renderTreemap(stocks) {
            // Clear previous chart
            d3.select(portfolioTreemapChartSvg).selectAll("*").remove();

            // Dynamic width and height based on the parent container
            const chartContainerWidth = Math.min(portfolioTreemapChartSvg.parentElement.clientWidth, 700); // Sets a max width of 1200px

            // Maintain original aspect ratio (e.g., 500/300 = 1.666)
            const aspectRatio = 700 / 300;
            const width = chartContainerWidth;
            const height = width / aspectRatio;

            // Set the SVG's viewbox for proper scaling
            d3.select(portfolioTreemapChartSvg)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet")
                .attr("height", height); // Explicitly set height based on calculated value


            // Filter out stocks with invalid market price or zero shares/value
            const validStocks = stocks.filter(d => d.marketPrice && d.shares > 0 && (d.shares * d.marketPrice) > 0);

            if (validStocks.length === 0) {
                d3.select(portfolioTreemapChartSvg).append("text")
                    .attr("x", width / 2)
                    .attr("y", height / 2)
                    .attr("text-anchor", "middle")
                    .attr("fill", "var(--tw-text-gray-500)") /* Use Tailwind variable for dark mode compatibility */
                    .text("No data for treemap (check market prices and shares)");
                return;
            }

            // Create hierarchical data for the treemap
            const root = d3.hierarchy({ children: validStocks })
                .sum(d => d.shares * d.marketPrice) // Sum by current market value
                .sort((a, b) => b.value - a.value); // Sort by value descending

            const treemapLayout = d3.treemap()
                .size([width, height])
                .padding(1); // Small padding between rectangles

            treemapLayout(root);

            // Define a color scale for performance (Gain/Loss %)
            // Domain: -30% (loss) to 30% (gain), with 0% as neutral
            // Range: Tailwind red-500, gray-300, green-500
            const colorScale = d3.scaleLinear()
                .domain([-30, 0, 30])
                .range(["#ef4444", "#d1d5db", "#10b981"]);

            // Dark mode color adjustments for the scale
            const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (prefersDarkMode) {
                colorScale.range(["#ef4444", "#d1d5db", "#10b981"]); // Lighter red, darker gray, lighter green for dark mode
            }


            const nodes = d3.select(portfolioTreemapChartSvg)
                .selectAll("g")
                .data(root.leaves())
                .enter()
                .append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x0},${d.y0})`);

            nodes.append("rect")
                .attr("width", d => d.x1 - d.x0)
                .attr("height", d => d.y1 - d.y0)
                .attr("fill", d => {
                    const cost = d.data.shares * d.data.dcaPrice;
                    const value = d.data.shares * d.data.marketPrice;
                    const gainLossPercent = cost > 0 ? ((value - cost) / cost) * 100 : 0;
                    // console.log(`Ticker: ${d.data.ticker}, GainLossPercent: ${gainLossPercent.toFixed(2)}%, Color: ${colorScale(gainLossPercent)}`); // Log for debugging
                    return colorScale(gainLossPercent);
                });

            nodes.append("text")
                // .attr("x", d => (d.x0 + d.x1) / 2) // Center horizontally
                // .attr("y", d => (d.y0 + d.y1) / 2) // Center vertically
                .attr("x", 4) // Padding from left edge
                .attr("y", 14) // Padding from top edge
                // .attr("text-anchor", "middle") // Align text horizontally to the middle of its x position
                .attr("dominant-baseline", "middle") // Align text vertically to the middle of its y position
                .text(d => {
                    const cost = d.data.shares * d.data.dcaPrice;
                    const value = d.data.shares * d.data.marketPrice;
                    const percentage = cost > 0 ? ((value - cost) / cost) * 100 : 0;
                    // Only show text if the rectangle is large enough
                    if ((d.x1 - d.x0) > 5 && (d.y1 - d.y0) > 5) {
                        return `${d.data.ticker} (${percentage.toFixed(1)}%)`;
                    }
                    return `${d.data.ticker} (${percentage.toFixed(1)}%)`;
                })
                .attr("clip-path", d => `url(#clip-${d.data.id})`); // Clip text if it overflows

            // Add clip paths for text
            nodes.append("clipPath")
                .attr("id", d => `clip-${d.data.id}`)
                .append("rect")
                .attr("width", d => d.x1 - d.x0 - 4) // Subtract padding
                .attr("height", d => d.y1 - d.y0 - 4); // Subtract padding

            // Optional: Add tooltips for more detail on hover
            nodes.append("title")
                .text(d => {
                    const cost = d.data.shares * d.data.dcaPrice;
                    const value = d.data.shares * d.data.marketPrice;
                    const gainLoss = value - cost;
                    const gainLossPercent = cost > 0 ? (gainLoss / cost) * 100 : 0;
                    return `${d.data.ticker}\nValue: $${d.value.toFixed(2)}\nGain/Loss: $${gainLoss.toFixed(2)} (${gainLossPercent.toFixed(2)}%)`;
                });
        }

        /**
         * Renders a D3.js line chart for historical portfolio performance.
         * @param {Array<Object>} snapshots - The array of daily snapshot objects.
         */
        function renderHistoricalChart(snapshots) {
            d3.select(historicalPerformanceChartSvg).selectAll("*").remove(); // Clear previous chart

            if (snapshots.length === 0) {
                d3.select(historicalPerformanceChartSvg).append("text")
                    .attr("x", historicalPerformanceChartSvg.clientWidth / 2)
                    .attr("y", historicalPerformanceChartSvg.clientHeight / 2)
                    .attr("text-anchor", "middle")
                    .attr("fill", "var(--tw-text-gray-500)")
                    .text("No historical data available. Save a snapshot!");
                return;
            }

            // Set up dimensions and margins
            const margin = { top: 20, right: 30, bottom: 40, left: 60 };
            const containerWidth = historicalPerformanceChartSvg.clientWidth * 2;
            const containerHeight = 400; // Fixed height for consistency
            const width = containerWidth - margin.left - margin.right;
            const height = containerHeight - margin.top - margin.bottom;

            d3.select(historicalPerformanceChartSvg)
                .attr("viewBox", `0 0 ${containerWidth} ${containerHeight}`)
                .attr("preserveAspectRatio", "xMidYMid meet")
                .attr("height", containerHeight);

            const svg = d3.select(historicalPerformanceChartSvg)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Parse dates
            const parseDate = d3.timeParse("%Y-%m-%d");
            snapshots.forEach(d => {
                d.date = parseDate(d.date);
                d.totalValue = +d.totalValue; // Convert to number
                d.totalCost = +d.totalCost;   // Convert to number
            });

            // Set up scales
            const xScale = d3.scaleTime()
                .domain(d3.extent(snapshots, d => d.date))
                .range([0, width]);

            const yScale = d3.scaleLinear()
                .domain([0, d3.max(snapshots, d => Math.max(d.totalValue, d.totalCost)) * 1.1]) // 10% padding above max
                .range([height, 0]);

            // Define the lines
            const valueLine = d3.line()
                .x(d => xScale(d.date))
                .y(d => yScale(d.totalValue));

            const costLine = d3.line()
                .x(d => xScale(d.date))
                .y(d => yScale(d.totalCost));

            // Add the X Axis
            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(xScale).tickFormat(d3.timeFormat("%b %d"))); // Format date ticks

            // Add the Y Axis
            svg.append("g")
                .attr("class", "y axis")
                .call(d3.axisLeft(yScale)
                    .tickValues(d3.range(0, yScale.domain()[1] + 1000, 1000)) // Generate ticks every $1000
                    .tickFormat(d3.format("$,.0f"))); // Format as currency

            // Add the value line
            svg.append("path")
                .data([snapshots])
                .attr("class", "line value")
                .attr("d", valueLine);

            // Add the cost line
            svg.append("path")
                .data([snapshots])
                .attr("class", "line cost")
                .attr("d", costLine);

            // Add tooltips (optional, more complex implementation needed for full functionality)
            const tooltip = d3.select("body").append("div")
                .attr("class", "chart-tooltip");

            svg.selectAll(".dot")
                .data(snapshots)
                .enter().append("circle")
                .attr("class", "dot")
                .attr("cx", d => xScale(d.date))
                .attr("cy", d => yScale(d.totalValue))
                .attr("r", 4)
                .attr("fill", "#6366f1")
                .style("opacity", 0)
                .on("mouseover", function(event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`Date: ${d3.timeFormat("%Y-%m-%d")(d.date)}<br/>Value: $${d.totalValue.toFixed(2)}<br/>Cost: $${d.totalCost.toFixed(2)}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                    d3.select(this).attr("r", 6).style("opacity", 1);
                })
                .on("mouseout", function(d) {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                    d3.select(this).attr("r", 4).style("opacity", 0);
                });
        }

        /**
         * Saves a snapshot of the current portfolio performance to Firestore.
         */
        async function saveDailySnapshot() {
            if (!db || !currentUserId) {
                showMessage("Error: Not authenticated or database not ready.", 'error');
                return;
            }

            // Ensure all stock prices are valid before saving
            const allPricesValid = portfolioData.stocks.every(stock => stock.marketPrice && stock.marketPrice > 0);
            if (!allPricesValid) {
                showMessage("Cannot save snapshot: Not all stock market prices are available or valid. Please refresh prices first.", 'error');
                return;
            }

            const today = new Date();
            const dateString = today.toISOString().split('T')[0]; // YYYY-MM-DD

            const totalCost = portfolioData.stocks.reduce((sum, stock) => sum + (stock.shares * stock.dcaPrice), 0);
            const totalValue = portfolioData.stocks.reduce((sum, stock) => sum + (stock.shares * stock.marketPrice), 0);
            const totalDividends = portfolioData.dividends.reduce((sum, dividend) => sum + dividend.amount, 0);
            const totalGainLoss = (totalValue - totalCost) + totalDividends;

            const snapshotData = {
                date: dateString,
                totalCost: totalCost,
                totalValue: totalValue,
                totalDividends: totalDividends,
                totalGainLoss: totalGainLoss,
                timestamp: Date.now() // For internal ordering if needed
            };

            const docPath = `artifacts/${appId}/users/${currentUserId}/daily_snapshots/${dateString}`;
            const docRef = doc(db, docPath);

            try {
                await setDoc(docRef, snapshotData, { merge: true }); // Use merge to update if exists
                showMessage(`Daily snapshot for ${dateString} saved successfully!`, 'success');
            } catch (e) {
                console.error("Error saving daily snapshot:", e);
                showMessage(`Error saving daily snapshot: ${e.message}`, 'error');
            }
        }


        /**
         * Calls the Gemini API to get a stock insight.
         * @param {string} ticker - The stock ticker symbol.
         */
        async function getStockInsight(ticker) {
            // Clear previous insights and show loading
            insightResultDiv.innerHTML = '<div class="text-center text-indigo-500 dark:text-indigo-400">Generating insight...</div>';
            primaryBusinessDiv.textContent = 'N/A';
            recentHighlightDiv.textContent = 'N/A';
            generalOutlookDiv.textContent = 'N/A';
            analystConsensusDiv.textContent = 'N/A';
            economicMoatDiv.textContent = 'N/A';
            financialStatementsDiv.textContent = 'N/A';

            if (!ticker) {
                insightResultDiv.innerHTML = '<div class="text-red-500 dark:text-red-400">Please enter a ticker symbol.</div>';
                return;
            }

            const prompt = `Provide a structured JSON response about the company with ticker symbol ${ticker}. The response should contain the following fields: "primaryBusiness", "recentHighlight", "generalOutlook", "analystConsensus", "economicMoat", and "financialStatements". For "recentHighlight", summarize a key recent event or development. For "generalOutlook", provide a brief future perspective. For "analystConsensus", give a general idea of how analysts view the stock (e.g., "Buy", "Hold", "Sell" or a summary of sentiment). For "economicMoat", briefly describe any competitive advantages. For "financialStatements", provide a *summary* of typical key metrics found in a company's latest quarterly financial statement (e.g., Revenue, Net Income, EPS, Cash Flow) based on your general knowledge, explicitly stating that this is not real-time data. If you cannot find information for a field, set its value to "N/A". Keep each field's value concise, ideally a few sentences.`;
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "primaryBusiness": { "type": "STRING" },
                            "recentHighlight": { "type": "STRING" },
                            "generalOutlook": { "type": "STRING" },
                            "analystConsensus": { "type": "STRING" },
                            "economicMoat": { "type": "STRING" },
                            "financialStatements": { "type": "STRING" }
                        },
                        "required": ["primaryBusiness", "recentHighlight", "generalOutlook", "analystConsensus", "economicMoat", "financialStatements"]
                    }
                }
            };
            const apiKey = "AIzaSyC4hyDgZWg7NhE16koEKeYq76kKY8VsyPU"; // Canvas will provide this for gemini-2.0-flash
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} - ${errorData.error.message || 'Unknown error'}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    try {
                        const parsedInsight = JSON.parse(jsonText);
                        primaryBusinessDiv.textContent = parsedInsight.primaryBusiness || 'N/A';
                        recentHighlightDiv.textContent = parsedInsight.recentHighlight || 'N/A';
                        generalOutlookDiv.textContent = parsedInsight.generalOutlook || 'N/A';
                        analystConsensusDiv.textContent = parsedInsight.analystConsensus || 'N/A';
                        economicMoatDiv.textContent = parsedInsight.economicMoat || 'N/A';
                        financialStatementsDiv.textContent = parsedInsight.financialStatements || 'N/A';
                        insightResultDiv.innerHTML = '<div class="text-center text-green-500 dark:text-green-400">Insight generated successfully!</div>';
                    } catch (parseError) {
                        console.error("Error parsing Gemini API response JSON:", parseError);
                        insightResultDiv.innerHTML = `<div class="text-red-500 dark:text-red-400">Failed to parse insight: ${parseError.message}. Raw response: ${jsonText}</div>`;
                    }
                } else {
                    insightResultDiv.innerHTML = '<div class="text-red-500 dark:text-red-400">No insight could be generated for this ticker.</div>';
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                insightResultDiv.innerHTML = `<div class="text-red-500 dark:text-red-400">Failed to get insight: ${error.message}</div>`;
            }
        }


        // Event Listeners
        window.onload = initializeFirebase; // Initialize Firebase when the window loads

        // Login/Signup buttons
        loginBtn.addEventListener('click', handleLogin);
        signupBtn.addEventListener('click', handleSignUp);

        // Navigation buttons
        navEntryBtn.addEventListener('click', () => {
            showPage(entryPage);
            hasFetchedPricesOnDashboardLoad = false; // Reset flag when leaving dashboard
        });
        navDashboardBtn.addEventListener('click', () => showPage(dashboardPage));
        logoutBtn.addEventListener('click', handleLogout);

        // Add Stock and Record Dividend buttons
        addStockBtn.addEventListener('click', addStock);
        recordDividendBtn.addEventListener('click', recordDividend); // New event listener for dividend

        // Save Daily Snapshot button
        saveSnapshotBtn.addEventListener('click', saveDailySnapshot);

        // LLM Insight button
        getInsightBtn.addEventListener('click', () => {
            const ticker = insightTickerInput.value.trim().toUpperCase();
            getStockInsight(ticker);
        });

        // Dividend History Table Header Sorting
        if (dividendTableHeaderDate) {
            dividendTableHeaderDate.addEventListener('click', () => {
                if (currentDividendSortKey === 'date') {
                    currentDividendSortOrder = currentDividendSortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    currentDividendSortKey = 'date';
                    currentDividendSortOrder = 'desc'; // Default to descending for date
                }
                renderDividendHistory(portfolioData.dividends, currentDividendSortKey, currentDividendSortOrder);
            });
        }

        if (dividendTableHeaderTicker) {
            dividendTableHeaderTicker.addEventListener('click', () => {
                if (currentDividendSortKey === 'ticker') {
                    currentDividendSortOrder = currentDividendSortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    currentDividendSortKey = 'ticker';
                    currentDividendSortOrder = 'asc'; // Default to ascending for ticker
                }
                renderDividendHistory(portfolioData.dividends, currentDividendSortKey, currentDividendSortOrder);
            });
        }
        // Add a resize event listener to re-render the treemap and historical chart when the window size changes
        window.addEventListener('resize', () => {
            // Only re-render if the dashboard is currently visible and there's portfolio data
            if (!dashboardPage.classList.contains('hidden')) {
                if (portfolioData.stocks.length > 0) {
                    renderTreemap(portfolioData.stocks);
                }
                if (dailySnapshots.length > 0) {
                    renderHistoricalChart(dailySnapshots);
                }
            }
        });

    </script>
</body>
</html>
